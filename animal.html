<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chicken Run V16 - Animasi Tabrakan</title>
    <style>
        body {
            margin: 0; padding: 0; background-color: #222; display: flex;
            flex-direction: column; align-items: center; justify-content: center; height: 100vh;
            font-family: 'Comic Sans MS', cursive, sans-serif;
            overflow: hidden;
        }
        #gameContainer {
            position: relative; box-shadow: 0 10px 40px rgba(0,0,0,1);
            border-radius: 10px; overflow: hidden; border: 5px solid #555;
        }
        canvas { display: block; }
        #ui {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white; z-index: 10;
        }
        .btn {
            background-color: #E91E63; border: none; padding: 12px 25px; margin: 10px;
            font-size: 18px; color: white; border-radius: 5px; cursor: pointer;
            font-weight: bold; box-shadow: 0 5px #880E4F; transition: 0.2s;
        }
        .btn:active { box-shadow: 0 0 #880E4F; transform: translateY(5px); }
        .btn-mode { background-color: #9C27B0; box-shadow: 0 5px #4A148C; font-size: 22px; margin-bottom: 20px;}
        .btn-mode:active { box-shadow: 0 0 #4A148C; transform: translateY(5px); }
        .btn-start { background-color: #4CAF50; box-shadow: 0 5px #1B5E20; margin-top: 20px;}
        .btn-start:active { box-shadow: 0 0 #1B5E20; }
        
        .name-input { 
            padding: 10px; margin: 8px; border-radius: 8px; border: 2px solid #E91E63; 
            font-size: 16px; text-align: center; font-family: 'Comic Sans MS', cursive;
            width: 200px; display: block;
        }
        .name-input:focus { outline: none; border-color: #4CAF50; }

        #controls { margin-top: 15px; background: rgba(255,255,255,0.9); padding: 15px; border-radius: 10px; display: flex; gap: 15px; }
        .control-box { text-align: center; font-weight: bold; font-size: 14px; padding: 10px; border-radius: 8px; }
    </style>
</head>
<body>

    <audio id="bgMusic" src="youtube_24018.mp3" loop></audio>
    <audio id="deathSound" src="tamatlah-sudah.mp3"></audio>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <div id="ui">
            <div id="menuScreen" style="display: flex; flex-direction: column; align-items: center;">
                <h2 id="titleText">Pilih Mode & Pemain!</h2>
                <button id="modeBtn" class="btn btn-mode" onclick="toggleMode()">Mode: Klasik üéÆ</button>
                <div>
                    <button class="btn" onclick="showNameInput(2)">2 Pemain</button>
                    <button class="btn" onclick="showNameInput(3)">3 Pemain</button>
                    <button class="btn" onclick="showNameInput(4)">4 Pemain</button>
                </div>
            </div>

            <div id="nameScreen" style="display: none; flex-direction: column; align-items: center;">
                <h2>Masukkan Nama Pemain!</h2>
                <div id="nameInputs"></div>
                <button class="btn btn-start" onclick="startGame()">Mulai Game! üöÄ</button>
            </div>
        </div>
    </div>

    <div id="controls">
        <div class="control-box" style="background: #ffcccc; color: #cc0000;">P1 üêî (Q)</div>
        <div class="control-box" style="background: #cce5ff; color: #004085;">P2 üêß (P)</div>
        <div class="control-box" style="background: #fff3cd; color: #856404;">P3 üê• (Z)</div>
        <div class="control-box" style="background: #d4edda; color: #155724;">P4 üê∏ (M)</div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const ui = document.getElementById('ui');
        const menuScreen = document.getElementById('menuScreen');
        const nameScreen = document.getElementById('nameScreen');
        const titleText = document.getElementById('titleText');
        const modeBtn = document.getElementById('modeBtn');
        const nameInputsDiv = document.getElementById('nameInputs');
        
        const bgMusic = document.getElementById('bgMusic'); 
        const deathSound = document.getElementById('deathSound'); 

        let isPlaying = false;
        let animationId;
        let speed = 6;
        let frameCount = 0;
        let selectedPlayerCount = 2;
        
        let isKingMode = false;
        let kingId = null;
        let stealCooldown = 0;

        let obstacles = [];
        let backgroundObjects = [];
        let clouds = []; 
        let nightStars = [];
        let powerUps = [];
        
        let currentMapIndex = 0;
        let nightAlpha = 0; 

        const maps = [
            { name: 'Hutan üå≤', bg: '#87CEEB', floor: '#4CAF50', ground: '#8D6E63', bgObjects: ['üè°', 'üå≥', 'üåª'] },
            { name: 'Gurun üåµ', bg: '#FFD54F', floor: '#FFCA28', ground: '#FF8F00', bgObjects: ['üèúÔ∏è', 'üåµ', '‚òÄÔ∏è', 'üêç'] },
            { name: 'Salju ‚ùÑÔ∏è', bg: '#E0F7FA', floor: '#FFFFFF', ground: '#B0BEC5', bgObjects: ['üè†', 'üèîÔ∏è', '‚òÉÔ∏è'] },
            { name: 'Candy Land üç≠', bg: '#FFB6C1', floor: '#FFD700', ground: '#FF69B4', bgObjects: ['üç¨', 'üç≠', 'üç©', 'üç¶'] }
        ];
        
        const allPlayers = [
            { id: 1, emoji: 'üêî', key: 'q', y: 330, grav: 1, alive: true, invincible: false, invTimer: 0, x: 150, name: '' },
            { id: 2, emoji: 'üêß', key: 'p', y: 330, grav: 1, alive: true, invincible: false, invTimer: 0, x: 105, name: '' },
            { id: 3, emoji: 'üê•', key: 'z', y: 330, grav: 1, alive: true, invincible: false, invTimer: 0, x: 60, name: '' },
            { id: 4, emoji: 'üê∏', key: 'm', y: 330, grav: 1, alive: true, invincible: false, invTimer: 0, x: 15, name: '' }
        ];
        let activePlayers = [];

        function toggleMode() {
            isKingMode = !isKingMode;
            modeBtn.innerText = isKingMode ? "Mode: Raja üëë" : "Mode: Klasik üéÆ";
        }

        function showNameInput(num) {
            selectedPlayerCount = num;
            menuScreen.style.display = 'none';
            nameScreen.style.display = 'flex';
            
            nameInputsDiv.innerHTML = '';
            for(let i = 0; i < num; i++) {
                nameInputsDiv.innerHTML += `<input type="text" id="nameP${i+1}" class="name-input" placeholder="Nama ${allPlayers[i].emoji}" maxlength="10">`;
            }
        }

        document.addEventListener('keydown', (e) => {
            if (!isPlaying) return;
            const key = e.key.toLowerCase();
            activePlayers.forEach(p => {
                if (p.key === key && p.alive) p.grav *= -1; 
            });
        });

        function initEnvironment() {
            clouds = []; nightStars = [];
            for(let i=0; i<4; i++) clouds.push({ x: Math.random() * canvas.width, y: Math.random() * (canvas.height - 180) + 40, size: 30 + Math.random() * 25, speed: 0.5 + Math.random() * 1.5 });
            for(let i=0; i<40; i++) nightStars.push({ x: Math.random() * canvas.width, y: Math.random() * 350, size: Math.random() * 2.5 });
        }

        function startGame() {
            ui.style.display = 'none';
            activePlayers = JSON.parse(JSON.stringify(allPlayers.slice(0, selectedPlayerCount)));
            
            for(let i = 0; i < selectedPlayerCount; i++) {
                let inputVal = document.getElementById(`nameP${i+1}`).value.trim();
                activePlayers[i].name = inputVal !== '' ? inputVal : `Pemain ${i+1}`;
            }

            obstacles = []; backgroundObjects = []; powerUps = [];
            initEnvironment(); 
            currentMapIndex = 0; 
            nightAlpha = 0; speed = 6.5; frameCount = 0;
            
            if (isKingMode) kingId = activePlayers[Math.floor(Math.random() * activePlayers.length)].id;
            else kingId = null;
            stealCooldown = 0;

            isPlaying = true;
            
            bgMusic.currentTime = 0;
            bgMusic.play().catch(e => console.log("Lagu diblokir browser, klik layar dulu untuk memulai audio"));

            gameLoop();
        }

        function gameOver(winnerMsg) {
            isPlaying = false;
            cancelAnimationFrame(animationId);
            bgMusic.pause();

            ui.style.display = 'flex';
            menuScreen.style.display = 'flex';
            nameScreen.style.display = 'none';
            titleText.innerText = winnerMsg;
        }

        function killPlayer(p) {
            if (p.alive) {
                p.alive = false;
                deathSound.currentTime = 0; 
                deathSound.play().catch(e => console.log("SFX Mati diblokir"));
            }
        }

        function drawBackground() {
            let map = maps[currentMapIndex];
            ctx.fillStyle = map.bg; ctx.fillRect(0, 0, canvas.width, canvas.height);

            if (nightAlpha > 0) {
                ctx.fillStyle = `rgba(10, 10, 40, ${nightAlpha})`; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = `rgba(255, 255, 255, ${nightAlpha})`;
                nightStars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.size, 0, Math.PI*2); ctx.fill(); });
            }

            ctx.fillStyle = map.ground; ctx.fillRect(0, 370, canvas.width, 30); ctx.fillRect(0, 0, canvas.width, 30);
            ctx.fillStyle = map.floor; 
            for(let i = 0; i < canvas.width; i+=40) {
                ctx.fillRect(i - (frameCount * speed % 40), 360, 20, 10); ctx.fillRect(i - (frameCount * speed % 40), 30, 20, 10);
            }
            if (nightAlpha > 0) {
                ctx.fillStyle = `rgba(0, 0, 0, ${nightAlpha * 0.5})`; ctx.fillRect(0, 360, canvas.width, 40); ctx.fillRect(0, 0, canvas.width, 40);
            }

            ctx.fillStyle = "rgba(0,0,0,0.15)"; ctx.font = "bold 40px Arial"; ctx.textAlign = "center";
            ctx.fillText(map.name, canvas.width / 2, canvas.height / 2); ctx.textAlign = "left"; 
        }

        function drawEnvironment() {
            clouds.forEach(c => {
                c.x -= c.speed; ctx.font = `${c.size}px Arial`; ctx.globalAlpha = 1 - (nightAlpha * 0.6);
                ctx.fillText('‚òÅÔ∏è', c.x, c.y); ctx.globalAlpha = 1.0;
                if (c.x + c.size < -20) { c.x = canvas.width + 50; c.y = Math.random() * (canvas.height - 180) + 40; }
            });
            for (let i = 0; i < backgroundObjects.length; i++) {
                let obj = backgroundObjects[i]; obj.x -= obj.speed; ctx.globalAlpha = 1 - (nightAlpha * 0.4);
                ctx.font = `${obj.size}px Arial`; ctx.fillText(obj.emoji, obj.x, obj.y); ctx.globalAlpha = 1.0;
                if (obj.x + obj.size < 0) { backgroundObjects.splice(i, 1); i--; }
            }
        }

        function spawnPowerUp() {
            if (frameCount > 0 && frameCount % 300 === 0) {
                let types = ['‚≠ê', 'üîÑ', 'üí®', 'üí®']; 
                powerUps.push({ type: types[Math.floor(Math.random() * types.length)], x: canvas.width, y: Math.random() * 200 + 80, size: 35 });
            }
            if (frameCount % 150 === 0) { 
                let map = maps[currentMapIndex];
                let objIndex = Math.floor(Math.random() * map.bgObjects.length);
                backgroundObjects.push({ emoji: map.bgObjects[objIndex], x: canvas.width, y: Math.random() * (canvas.height - 120) + 60, size: 30 + Math.random() * 25, speed: speed * 0.3 });
            }
        }

        function getBoxType() { return Math.random() > 0.5 ? 'box' : 'blocker'; }

        function spawnObstacle() {
            let spawnRate = Math.max(40, 90 - Math.floor(speed * 3)); 
            if (frameCount % spawnRate === 0) {
                if (isKingMode && Math.random() < 0.25) {
                    obstacles.push({ type: 'missile', x: canvas.width, y: Math.random() * 250 + 50, w: 40, h: 30 });
                    return; 
                }

                let pattern = Math.floor(Math.random() * 7); 
                let startX = canvas.width;

                if (pattern === 0) {
                    let isTop = Math.random() > 0.5; obstacles.push({ type: getBoxType(), x: startX, y: isTop ? 40 : 320, w: 40, h: 40, color: '#F44336' });
                } 
                else if (pattern === 1) obstacles.push({ type: 'moving', x: startX, y: 150, w: 30, h: 60, color: '#00BCD4', dy: 3 });
                else if (pattern === 2) obstacles.push({ type: 'gear', x: startX, y: 180, w: 40, h: 40, angle: 0 });
                else if (pattern === 3) {
                    obstacles.push({ type: 'platform', x: startX, y: 191, w: 250, h: 25 });
                    obstacles.push({ type: getBoxType(), x: startX + 100, y: 191 - 30, w: 30, h: 30, color: '#F44336' });
                }
                else if (pattern === 4) {
                    obstacles.push({ type: getBoxType(), x: startX, y: 40, w: 30, h: 60, color: '#F44336' }); 
                    obstacles.push({ type: getBoxType(), x: startX + 150, y: 300, w: 30, h: 60, color: '#F44336' });
                }
                else if (pattern === 5) {
                    let isTopHole = Math.random() > 0.5; let holeSize = 150 + Math.random() * 100; 
                    obstacles.push({ type: 'hole', x: startX, y: isTopHole ? 0 : 360, w: holeSize, h: 40 }); 
                }
                else if (pattern === 6) {
                    obstacles.push({ type: 'platform', x: startX, y: 120, w: 150, h: 25 });
                    obstacles.push({ type: 'platform', x: startX + 220, y: 250, w: 150, h: 25 });
                }
            }
        }

        function gameLoop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            let map = maps[currentMapIndex]; 
            
            let cycle = frameCount % 1000;
            if (cycle > 500 && cycle < 950) nightAlpha = Math.min(nightAlpha + 0.005, 0.7); 
            else if (cycle >= 950 || cycle < 50) nightAlpha = Math.max(nightAlpha - 0.02, 0); 

            drawBackground();
            drawEnvironment();

            frameCount++;
            if (frameCount % 400 === 0) speed += 0.5; 

            if (frameCount > 0 && frameCount % 1000 === 0) {
                currentMapIndex = (currentMapIndex + 1) % maps.length; backgroundObjects = []; 
            }

            spawnObstacle();
            spawnPowerUp();

            if (isKingMode) {
                let kingPlayer = activePlayers.find(p => p.id === kingId && p.alive);
                if (!kingPlayer) {
                    let alivePlayers = activePlayers.filter(p => p.alive);
                    if (alivePlayers.length > 0) kingId = alivePlayers[Math.floor(Math.random() * alivePlayers.length)].id;
                } else {
                    if (stealCooldown === 0) {
                        activePlayers.forEach(p => {
                            if (p.alive && p.id !== kingId) {
                                if (Math.abs(p.y - kingPlayer.y) < 25) { kingId = p.id; stealCooldown = 30; }
                            }
                        });
                    }
                }
                if (stealCooldown > 0) stealCooldown--;
            }

            for (let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                if (obs.type === 'missile') {
                    obs.x -= (speed + 2.5); 
                    if (isKingMode) {
                        let king = activePlayers.find(p => p.id === kingId && p.alive);
                        if (king && obs.x > king.x) {
                            if (obs.y < king.y + 10) obs.y += 1.5;
                            if (obs.y > king.y + 10) obs.y -= 1.5;
                        }
                    }
                    ctx.font = "30px Arial"; ctx.fillText("üöÄ", obs.x, obs.y + 25);
                }
                else {
                    obs.x -= speed;
                    if (obs.type === 'box') {
                        ctx.fillStyle = obs.color; ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                        ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
                    } 
                    else if (obs.type === 'blocker') {
                        ctx.fillStyle = map.ground; ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                        ctx.strokeStyle = map.floor; ctx.lineWidth = 3; 
                        ctx.strokeRect(obs.x + 2, obs.y + 2, obs.w - 4, obs.h - 4); 
                    }
                    else if (obs.type === 'platform') {
                        ctx.fillStyle = map.ground; ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                        ctx.fillStyle = map.floor;
                        ctx.fillRect(obs.x, obs.y, obs.w, 6); ctx.fillRect(obs.x, obs.y + obs.h - 6, obs.w, 6); 
                        ctx.strokeStyle = "black"; ctx.lineWidth = 2; ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
                    }
                    else if (obs.type === 'moving') {
                        obs.y += obs.dy; if (obs.y <= 40 || obs.y + obs.h >= 360) obs.dy *= -1; 
                        ctx.fillStyle = obs.color; ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                        ctx.strokeStyle = "white"; ctx.strokeRect(obs.x, obs.y, obs.w, obs.h);
                    } 
                    else if (obs.type === 'gear') {
                        ctx.save(); ctx.translate(obs.x + obs.w/2, obs.y + obs.h/2); obs.angle += 0.15; ctx.rotate(obs.angle);
                        ctx.font = "45px Arial"; ctx.textAlign = "center"; ctx.textBaseline = "middle"; ctx.fillText("‚öôÔ∏è", 0, 0); ctx.restore();
                    }
                    else if (obs.type === 'hole') {
                        ctx.fillStyle = map.bg; ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                        if (nightAlpha > 0) { ctx.fillStyle = `rgba(10, 10, 40, ${nightAlpha})`; ctx.fillRect(obs.x, obs.y, obs.w, obs.h); }
                    }
                }
                if (obs.x + obs.w < -50) { obstacles.splice(i, 1); i--; }
            }

            for (let i = 0; i < powerUps.length; i++) {
                let pu = powerUps[i]; pu.x -= speed;
                let floatY = pu.y + Math.sin(frameCount * 0.1) * 5;
                ctx.font = `${pu.size}px Arial`; ctx.fillText(pu.type, pu.x, floatY);

                activePlayers.forEach(p => {
                    if (p.alive && !pu.taken) {
                        if (p.x < pu.x + pu.size && p.x + 30 > pu.x && p.y < floatY + pu.size && p.y + 30 > floatY) {
                            pu.taken = true;
                            if (pu.type === '‚≠ê') { p.invincible = true; p.invTimer = 300; } 
                            else if (pu.type === 'üí®') { 
                                p.x += 100; 
                                if (p.x > canvas.width - 50) p.x = canvas.width - 50; 
                            }
                            else if (pu.type === 'üîÑ') {
                                let others = activePlayers.filter(other => other.alive && other.id !== p.id);
                                if (others.length > 0) {
                                    let target = others[Math.floor(Math.random() * others.length)];
                                    let tempY = p.y; let tempGrav = p.grav; let tempX = p.x;
                                    p.y = target.y; p.grav = target.grav; p.x = target.x;
                                    target.y = tempY; target.grav = tempGrav; target.x = tempX;
                                }
                            }
                        }
                    }
                });
                if (pu.x + pu.size < -50 || pu.taken) { powerUps.splice(i, 1); i--; }
            }

            let aliveCount = 0;
            let lastAlive = null;

            ctx.textAlign = "left"; ctx.textBaseline = "bottom";

            activePlayers.forEach(p => {
                if (p.alive) {
                    p.y += p.grav * 10; 
                    p.isBlocked = false;
                    
                    if (p.invincible) {
                        p.invTimer--; if (p.invTimer <= 0) p.invincible = false;
                        ctx.save(); ctx.shadowColor = "yellow"; ctx.shadowBlur = 20; ctx.beginPath();
                        ctx.arc(p.x + 15, p.y + 15, 25, 0, Math.PI*2); ctx.fillStyle = "rgba(255, 215, 0, 0.4)"; ctx.fill(); ctx.restore();
                    }
                    
                    let overHoleTop = false; let overHoleBottom = false;
                    let platformTopY = null; let platformBottomY = null;
                    let hitBox = 8;

                    obstacles.forEach(obs => {
                        if (obs.type === 'hole') {
                            if (p.x + 15 > obs.x && p.x + 15 < obs.x + obs.w) {
                                if (obs.y === 0) overHoleTop = true; if (obs.y === 360) overHoleBottom = true;
                            }
                        }
                        
                        if (obs.type === 'blocker') {
                            if (p.y + 30 - hitBox > obs.y && p.y + hitBox < obs.y + obs.h) {
                                if (p.x + 30 > obs.x && p.x < obs.x + obs.w) {
                                    if (!p.invincible) {
                                        p.x = obs.x - 30; // Kedorong balok
                                        p.isBlocked = true; // Tandai bahwa pemain lagi nempel balok
                                    }
                                }
                            }
                        }

                        if (obs.type === 'platform') {
                            if (p.x + 30 - hitBox > obs.x && p.x + hitBox < obs.x + obs.w) {
                                if (p.grav > 0 && p.y + 30 - (p.grav * 10) <= obs.y + 15) platformTopY = obs.y;
                                if (p.grav < 0 && p.y - (p.grav * 10) >= obs.y + obs.h - 15) platformBottomY = obs.y + obs.h;
                                
                                if (platformTopY === null && platformBottomY === null) {
                                    if (p.y + 30 - hitBox > obs.y && p.y + hitBox < obs.y + obs.h) {
                                        if (!p.invincible) killPlayer(p); 
                                    }
                                }
                            }
                        }
                    });

                    if (platformTopY !== null) p.y = platformTopY - 30; 
                    else if (platformBottomY !== null) p.y = platformBottomY;   
                    else {
                        if (!overHoleBottom && p.y > 330) p.y = 330; 
                        if (!overHoleTop && p.y < 40) p.y = 40;     
                    }

                    // --- BAGIAN MENGGAMBAR PEMAIN (DENGAN ANIMASI HIT) ---
                    let drawX = p.x;
                    let drawY = p.y;

                    // Kalau lagi nyangkut/nempel balok, kasih animasi getar
                    if (p.isBlocked) {
                        drawX += (Math.random() * 6 - 3); // Getar kiri-kanan
                        drawY += (Math.random() * 6 - 3); // Getar atas-bawah
                        
                        // Gambar efek ledakan pas di titik tabrakan
                        ctx.font = "20px Arial";
                        ctx.fillText("üí•", p.x + 25, p.y + 20);
                    }

                    if (isKingMode && p.id === kingId) {
                        ctx.font = "20px Arial"; ctx.fillText("üëë", drawX + 5, drawY);
                    }
                    
                    ctx.font = "30px Arial"; ctx.fillText(p.emoji, drawX, drawY + 30);

                    ctx.font = "bold 14px 'Comic Sans MS', cursive";
                    ctx.textAlign = "center"; ctx.lineWidth = 3;
                    ctx.strokeStyle = "black"; ctx.strokeText(p.name, drawX + 15, drawY + 50);
                    ctx.fillStyle = "white"; ctx.fillText(p.name, drawX + 15, drawY + 50); 
                    ctx.textAlign = "left"; 
                    // -----------------------------------------------------

                    if (p.y > 400 || p.y < -30 || p.x < -30) killPlayer(p);

                    obstacles.forEach(obs => {
                        if (obs.type !== 'hole' && obs.type !== 'platform' && obs.type !== 'blocker') { 
                            if (p.x + hitBox < obs.x + obs.w && p.x + 30 - hitBox > obs.x && p.y + hitBox < obs.y + obs.h && p.y + 30 - hitBox > obs.y) {
                                if (!p.invincible) killPlayer(p); 
                            }
                        }
                    });

                    aliveCount++; lastAlive = p;
                } else {
                    ctx.globalAlpha = 0.5; ctx.font = "30px Arial";
                    ctx.fillText('üëª', p.x, p.y + 30); ctx.globalAlpha = 1.0;
                }
            });

            // Sistem Formasi
            let sortedAlivePlayers = [...activePlayers].filter(p => p.alive).sort((a, b) => b.x - a.x);
            
            sortedAlivePlayers.forEach((p, index) => {
                let targetX = (index === 0) ? 150 : sortedAlivePlayers[index - 1].x - 45;
                
                if (!p.isBlocked) {
                    if (p.x < targetX) {
                        p.x += 2; 
                        if (p.x > targetX) p.x = targetX; 
                    } else if (p.x > targetX) {
                        p.x -= 1; 
                        if (p.x < targetX) p.x = targetX;
                    }
                }
            });

            if (aliveCount === 1 && activePlayers.length > 1) {
                let winMsg = (isKingMode && lastAlive.id === kingId) ? `${lastAlive.name} Menang Sbg RAJA! üëë` : `${lastAlive.name} Menang! üèÜ`;
                setTimeout(() => gameOver(winMsg), 100); return;
            } else if (aliveCount === 0) {
                setTimeout(() => gameOver("Semua Gugur! Seri!"), 100); return;
            }

            animationId = requestAnimationFrame(gameLoop);
        }
    </script>
</body>
</html>
